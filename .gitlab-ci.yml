default:
  tags:
    - k8s
  image: registry.gitlab.com/hitchhikers/container-images/python-quality:latest

stages:
  - childs
  - release
  - root

.child-pipeline:
  stage: childs
  rules:
    - if: $CI_MERGE_REQUEST_ID
      changes:
        - $CI_JOB_NAME/**/*
  variables:
    PIPELINE_ROOT: $CI_JOB_NAME

core:
  extends: .child-pipeline
  trigger:
    include: core/core-pipeline.yml
    strategy: depend

tracing:
  extends: .child-pipeline
  trigger:
    include: tracing/tracing-pipeline.yml
    strategy: depend

ui:
  extends: .child-pipeline
  trigger:
    include: ui/ui-pipeline.yml
    strategy: depend

detection:
  extends: .child-pipeline
  trigger:
    include: detection/detection-pipeline.yml
    strategy: depend

root:
  stage: root
  rules:
    - if: $CI_MERGE_REQUEST_ID
  trigger:
    include: ci/code-pipeline.yml
    strategy: depend
  variables:
    PIPELINE_ROOT: $CI_JOB_NAME

# Publish new releases/tags when applicable from the commits
release:
  stage: release
  script:
    - semantic-release
  only:
    - master
